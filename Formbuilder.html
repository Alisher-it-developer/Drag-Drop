<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Person Data Fields</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7fc;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      overflow-y: auto;
    }

    .container {
      display: flex;
      height: 100vh;
      gap: 20px;
      padding: 20px;
    }

    /* Sidebar Styles - WIDER VERSION (350px) */
    .sidebar {
      flex: 0 0 350px;
      max-width: 300px;
      height: calc(100vh - 40px);
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 10px;
      scrollbar-width: thin;
      scrollbar-color: #00aaff #f4f7fc;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: #f4f7fc;
      border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: #00aaff;
      border-radius: 3px;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      min-width: 0;
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    /* Panel Styles */
    .section-panel,
    .layout-panel,
    .field-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      width: 100%;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 10px;
    }

    .field-panel-header {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
      font-weight: 600;
    }

    .field-panel strong {
      color: #0078d4;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
    }

    .field-button {
      background-color: #00aaff;
      color: white;
      border: none;
      padding: 10px 8px;
      cursor: move;
      font-size: 13px;
      border-radius: 2px;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .field-button:hover {
      background-color: #008bb5;
    }

    .field-button.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background-color: #cccccc;
      pointer-events: none;
    }

    .field-button.disabled:hover {
      background-color: #cccccc;
    }

    .layout-grid {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .layout-row {
      display: flex;
      height: 40px;
    }

    .layout-preview {
      cursor: move;
      user-select: none;
      width: 100%;
      display: flex;
      gap: 3px;
      padding: 3px;
    }

    .preview-cell {
      background-color: rgba(7, 197, 255, 0.918);
      border-radius: 2px;
      flex: 1;
    }

    /* Grid Container Styles */
    .grid-container {
      width: 100%;
      margin: 10px 0;
      /* Adjusted margin for better spacing */
      background: transparent;
      display: flex;
      flex-direction: column;
    }

    .grid-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      min-height: 40px;
      background: transparent;
      width: 100%;
      /* Ensure full width */
      align-items: flex-start;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .grid-col {
      flex: 1;
      background: transparent;
      border: 2px dashed gray;
      padding: 15px;
      min-width: 0;
      overflow: auto;
      scrollbar-width: thin;
    }

    .grid-col.col-2 {
      flex: 2;
    }

    .grid-col.col-3 {
      flex: 3;
    }

    /* Form Field Styles */
    .form-field {
      margin-bottom: 10px;
    }

    .form-field label {
      display: block;
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .form-field input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid rgba(7, 197, 255, 0.2);
      border-radius: 4px;
      font-size: 14px;
      outline: none;
    }

    .form-field input:focus {
      border-color: rgba(7, 197, 255, 0.8);
    }

    /* Dropzone Styles */
    .dropzone {
      flex: 1;
      min-height: 100px;
      /* Ensure a reasonable height */
      background: white;
      border-radius: 8px;
      border: 1px solid rgba(7, 197, 255, 0.2);
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #00aaff #f4f7fc;
      position: relative;
      align-items: center;/
    }

    .dropzone::-webkit-scrollbar {
      width: 6px;
    }

    .dropzone::-webkit-scrollbar-track {
      background: #f4f7fc;
      border-radius: 3px;
    }

    .dropzone::-webkit-scrollbar-thumb {
      background: #00aaff;
      border-radius: 3px;
    }

    .dropzone-text {
      color: #666;
      font-size: 14px;
      pointer-events: none;
    }

    .dropzone.active {
      border-color: rgba(7, 197, 255, 0.8);
    }

    /* Dropzone Tab Styles */
    .tabs-container {
      display: flex;
      gap: 2px;
      margin-bottom: 20px;
      min-height: 40px;
      background: #f5f5f5;
      padding: 5px;
      border-radius: 4px;
      overflow-x: auto;
      scrollbar-width: thin;
      margin-right: 122px;
    }

    .tab {
      background: #00aaff;
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      transform-origin: center;
      cursor: pointer;
    }

    .tab.dragging {
      opacity: 0.5;
      transform: scale(1.05);
      z-index: 100;
    }

    .tab.slide-left {
      animation: slideLeft 0.3s ease forwards;
    }

    .tab.slide-right {
      animation: slideRight 0.3s ease forwards;
    }

    @keyframes slideLeft {
      0% {
        transform: translateX(0);
      }

      50% {
        transform: translateX(-5px);
      }

      100% {
        transform: translateX(0);
      }
    }

    @keyframes slideRight {
      0% {
        transform: translateX(0);
      }

      50% {
        transform: translateX(5px);
      }

      100% {
        transform: translateX(0);
      }
    }

    .tab-label {
      min-width: 60px;
      outline: none;
      padding: 2px 4px;
    }

    .tab-label:focus {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
    }

    .tab-actions {
      display: flex;
      gap: 8px;
      margin-left: 10px;
    }

    .tab-action {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.2);
      cursor: pointer;
      font-size: 14px;
    }

    .tab-action:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    .tab-move {
      cursor: move;
    }

    .tab.active {
      background: #0088cc;
    }

    .tab-dropzone {
      width: 100%;
      min-height: 110px;
      background: #ffffff;
      border: 1px solid rgba(7, 197, 255, 0.2);
      border-radius: 4px;
      padding: 20px;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tab-dropzone.active {
      border-color: rgba(7, 197, 255, 0.8);
    }

    /* Fieldset Styles */
    .fieldset-container {
      border: 4px solid #00aaff;
      border-radius: 4px;
      padding: 20px;
      margin-top: 20px;
      position: relative;
      z-index: 1;
    }

    /* Section Panel Styles */
    .section-header {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .section-item {
      margin-bottom: 20px;
    }

    .section-item-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .section-preview {
      cursor: move;
    }

    /* Tab Preview Structure */
    .tab-preview {
      position: relative;
      height: 80px;
    }

    .tab-preview-container {
      position: absolute;
      top: 0;
      left: 9px;
      right: 0;
      display: flex;
      gap: 3px;
    }

    .mini-tab {
      background: #00aaff;
      width: 20px;
      height: 20px;
      border-radius: 3px 3px 0 0;
    }

    .tab-preview-content {
      height: 60px;
      width: 96%;
      position: absolute;
      top: 20px;
      left: 0;
      border: 2px solid #00aaff;
      border-radius: 4px;
      background: rgba(7, 197, 255, 0.05);
    }

    /* Fieldset Preview Structure */
    .fieldset-preview {
      position: relative;
      height: 80px;
    }

    .mini-fieldset {
      position: absolute;
      top: 6px;
      left: 25%;
      transform: translateX(-50%);
      background: #00aaff;
      width: 90px;
      height: 25px;
      border-radius: 12px;
      z-index: 2;
    }

    .fieldset-preview-content {
      height: 60px;
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      border: 2px solid #00aaff;
      border-radius: 4px;
      background: rgba(7, 197, 255, 0.05);
      width: 96%;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
        height: auto;
        overflow: auto;
      }

      .sidebar {
        flex: none;
        max-width: none;
        width: 100%;
        height: auto;
        max-height: 40vh;
      }

      .main-content {
        height: 60vh;
      }
    }

    .column-icons {
      position: absolute;
      top: 35%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      display: none;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
      background: rgba(7, 197, 255, 0.05);
      z-index: 20;
    }

    .column-icons .left-icons {
      display: flex;
      gap: 10px;
    }

    .column-icons .center-icons {
      display: flex;
      gap: 10px;
    }

    .column-icons .right-icons {
      display: flex;
      gap: 8px;
    }

    .column-icons i:hover {
      color: #005a9e;
      transform: scale(1.2);
    }

    .grid-col:hover .column-icons {
      display: flex;
    }

    .add-column-button {
      transition: all 0.3s ease;
    }



    .add-column-button:hover {
      background-color: rgba(7, 197, 255, 0.1);
      border-color: rgba(7, 197, 255, 1);
    }

    .add-column-button:hover i {
      transform: scale(1.2);
    }

    .delete-column {
      cursor: pointer;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 15px;
    }

    .form-field input {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(7, 197, 255, 0.5);
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    .form-field input:focus {
      border-color: rgba(7, 197, 255, 0.8);
      outline: none;
    }

    .grid-col {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: hidden;
    }

    .field-panel-header {
      font-size: 16px;

    }

    .add-tab-dropzone {
      position: absolute;
      top: 23px;
      right: 19px;
      width: 120px;
      height: 42px;
      background: white;
      border: 2px dashed rgba(7, 197, 255, 0.8);
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #666;
      font-size: 14px;
      cursor: default;
      pointer-events: auto;
      /* Ensure it can receive drag-and-drop events */
    }

    .add-tab-dropzone.active {
      border-color: rgba(7, 197, 255, 1);
    }

    .grid-col-label {
      position: absolute;
      top: 20%;
      left: 10px;
      font-size: 12px;
      color: rgba(7, 197, 255, 0.8);
      font-weight: 600;
      transform: translateY(-50%);
      transition: all 0.2s ease;
      pointer-events: none;
    }



    .grid-col-label::after {
      content: ' *';
      color: red;
    }

    .grid-col input {
      width: 100%;
      border: none !important;
      background: transparent !important;
      font-size: 14px;
      padding: 0 !important;
      outline: none;
      position: relative;
      z-index: 20;
      line-height: normal;
    }

    .grid-col input:focus {
      z-index: 20;
    }

    .fieldset-name {
      position: relative;
      background-color: #f4f7fc;
      padding: 2px 5px;
      font-size: 14px;
      color: #333;
      cursor: text;
    }

    .fieldset-name:focus {
      background-color: #fff;
      border: 1px solid rgba(7, 197, 255, 0.8);
      border-radius: 4px;
      outline: none;
    }

    .fieldset-name-wrapper {
      position: absolute;
      top: -18px;
      /* Adjusted to move slightly higher, accounting for the 4px border */
      left: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      /* High z-index to ensure it’s above the fieldset-container */
      background: #f4f7fc;
      /* Match the body background to cover the border */
      padding: 0 5px;
      /* Add padding to create a gap around the name */
      border-radius: 4px;

    }

    .fieldset-icons {
      display: none;
      /* Hidden by default */
      gap: 5px;
      align-items: center;

    }

    .fieldset-icons.left-icons {
      position: absolute;
      left: -15px;
      /* Position to the left of the name */
      top: 50%;
      transform: translateY(-50%);
    }

    .fieldset-icons.right-icons {
      position: absolute;
      right: -15px;
      /* Position to the right of the name */
      top: 50%;
      transform: translateY(-50%);
    }


    /* .fieldset-container.dragging {
      opacity: 0.5;
      border-style: dashed;
      border-color: #00aaff;
    } */
  </style>
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Section Panel -->
      <div class="section-panel">
        <div class="section-header">SECTION</div>
        <!-- Tab Section -->
        <div class="section-item">
          <div class="section-item-label">TAB</div>
          <div class="section-preview" draggable="true" data-type="tab">
            <div class="tab-preview">
              <div class="tab-preview-container">
                <div class="mini-tab"></div>
                <div class="mini-tab"></div>
                <div class="mini-tab"></div>
              </div>
              <div class="tab-preview-content"></div>
            </div>
          </div>
        </div>
        <!-- Fieldset Section -->
        <div class="section-item">
          <div class="section-item-label">FIELDSET</div>
          <div class="section-preview" draggable="true" data-type="fieldset">
            <div class="fieldset-preview">
              <div class="mini-fieldset"></div>
              <div class="fieldset-preview-content"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Layout Panel -->
      <div class="layout-panel">
        <div class="field-panel-header">ROW</div>
        <div class="layout-grid">
          <!-- Single Row -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="1-row">
              <div class="preview-cell" style="height: 100%;"></div>
            </div>
          </div>
          <!-- Two equal columns -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="2-equal">
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
            </div>
          </div>
          <!-- Three equal columns -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="3-equal">
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
            </div>
          </div>
          <!-- Four equal columns -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="4-equal">
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
            </div>
          </div>
          <!-- 1:2 split -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="1-2-split">
              <div class="preview-cell"></div>
              <div class="preview-cell" style="flex: 2"></div>
            </div>
          </div>
          <!-- 2:1 split -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="2-1-split">
              <div class="preview-cell" style="flex: 2"></div>
              <div class="preview-cell"></div>
            </div>
          </div>
          <!-- 5 Equal Columns -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="5-equal">
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
              <div class="preview-cell"></div>
            </div>
          </div>
          <!-- 2-8-2 Split Columns -->
          <div class="layout-row">
            <div class="layout-preview" draggable="true" data-layout="2-8-2-split">
              <div class="preview-cell" style="flex: 2"></div>
              <div class="preview-cell" style="flex: 8"></div>
              <div class="preview-cell" style="flex: 2"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Field Panel -->
      <div class="field-panel">
        <div class="field-panel-header">Data Table: PERSON</div>
        <h5>Data Fields</h5>
        <div class="field-grid">
          <div class="field-button" draggable="true" data-type="title">Title</div>
          <div class="field-button" draggable="true" data-type="firstname">First Name</div>
          <div class="field-button" draggable="true" data-type="lastname">Last Name</div>
          <div class="field-button" draggable="true" data-type="address1">Address Line 1</div>
          <div class="field-button" draggable="true" data-type="address2">Address Line 2</div>
          <div class="field-button" draggable="true" data-type="suburb">Suburb</div>
          <div class="field-button" draggable="true" data-type="state">State</div>
          <div class="field-button" draggable="true" data-type="postcode">Postcode</div>
          <div class="field-button" draggable="true" data-type="country">Country</div>
          <div class="field-button" draggable="true" data-type="email">Email</div>
          <div class="field-button" draggable="true" data-type="url">URL</div>
          <div class="field-button" draggable="true" data-type="photo">Photo</div>
        </div>
      </div>
    </div>
    <!-- Main Content -->
    <div class="main-content">
      <!-- Dropzone -->
      <div class="dropzone" id="dropzone">
        <div class="dropzone-text" id="dropzone-text">Drop a Tab</div>
      </div>
    </div>
  </div>
  <div id="formContainer" style="display: none;"></div>

  <script>
    // Set up dragging for layout buttons
    document.querySelectorAll('.layout-preview').forEach(button => {
      button.addEventListener('dragstart', function (e) {
        e.dataTransfer.setData('layout', this.dataset.layout);
        e.dataTransfer.setData('type', 'layout');
      });
    });

    // Enable dragging for field buttons
    document.querySelectorAll('.field-button').forEach(button => {
      button.addEventListener('dragstart', function (e) {
        e.dataTransfer.setData('type', 'field');
        e.dataTransfer.setData('fieldType', this.dataset.type);
        e.dataTransfer.setData('label', this.innerText);
        e.dataTransfer.setData('fieldId', this.id); // Store the field button's ID
      });
    });

    // Ensure each field button has a unique ID
    document.querySelectorAll('.field-button').forEach((button, index) => {
      button.id = 'field-' + button.dataset.type;
    });

    document.querySelectorAll('.grid-row').forEach((element) => {
      element.addEventListener('dragover', (e) => {
        e.preventDefault();
      });
    });

    // Tab Counter
    let tabCounter = 1;

    // Tab dragging variables
    let draggedTab = null;
    let tabDragStartX = 0;
    let tabDragStartY = 0;

    // Set up dragging for section previews
    document.querySelectorAll('.section-preview').forEach(preview => {
      preview.addEventListener('dragstart', function (e) {
        e.dataTransfer.setData('type', this.dataset.type);
      });
    });

    function createTab() {
      const tabId = `tab-${tabCounter}`;
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.draggable = true;
      tab.dataset.tabId = tabId;

      const label = document.createElement('span');
      label.className = 'tab-label';
      label.contentEditable = true;
      label.textContent = `Tab ${tabCounter++}`;

      const actions = document.createElement('div');
      actions.className = 'tab-actions';

      const moveBtn = document.createElement('span');
      moveBtn.className = 'tab-action tab-move';
      moveBtn.innerHTML = '<i class="fas fa-arrows-alt"></i>';

      const deleteBtn = document.createElement('span');
      deleteBtn.className = 'tab-action tab-delete';
      deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        const content = document.getElementById(tabId + '-content');
        if (content) content.remove();
        tab.remove();
        const firstTab = document.querySelector('.tab');
        if (firstTab) {
          activateTab(firstTab);
        } else {
          const tabsContainer = document.getElementById('tabs-container');
          if (tabsContainer) tabsContainer.remove();
          const addTabDropzone = document.getElementById('add-tab-dropzone');
          if (addTabDropzone) addTabDropzone.remove();
          document.getElementById('dropzone-text').textContent = 'Drop a Tab';
          document.getElementById('dropzone-text').style.display = 'block';
        }
      };

      actions.appendChild(moveBtn);
      actions.appendChild(deleteBtn);
      tab.appendChild(label);
      tab.appendChild(actions);

      const tabContent = document.createElement('div');
      tabContent.id = tabId + '-content';
      tabContent.className = 'tab-dropzone';
      tabContent.style.display = 'none';

      const rowPlaceholder = document.createElement('div');
      rowPlaceholder.className = 'row-placeholder';
      rowPlaceholder.textContent = 'Drop a Row';
      rowPlaceholder.style.border = '3px dashed rgba(7, 197, 255, 0.8)';
      rowPlaceholder.style.padding = '20px';
      rowPlaceholder.style.textAlign = 'center';
      rowPlaceholder.style.color = '#666';
      rowPlaceholder.style.marginBottom = '10px';

      rowPlaceholder.addEventListener('dragover', (e) => {
        e.preventDefault();
        rowPlaceholder.classList.add('active');
      });

      rowPlaceholder.addEventListener('dragleave', () => {
        rowPlaceholder.classList.remove('active');
      });

      rowPlaceholder.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation(); // Stop the event from bubbling up to the main dropzone
        rowPlaceholder.classList.remove('active');

        // Check if the drop target is inside a fieldset's row-placeholder
        const isInsideFieldsetRow = e.target.closest('.fieldset-container .row-placeholder');
        if (isInsideFieldsetRow) {
          // Let the fieldset's row-placeholder handle the drop
          return;
        }

        const type = e.dataTransfer.getData('type');
        const layout = e.dataTransfer.getData('layout');

        if (type === 'layout' && layout) {
          createGridLayout(layout, tabContent);
          tabContent.appendChild(rowPlaceholder);
        } else {
          alert('Please drop a valid row layout.');
        }
      });

      tabContent.appendChild(rowPlaceholder);

      const dropzone = document.getElementById('dropzone');
      dropzone.appendChild(tabContent);

      tab.addEventListener('click', () => {
        activateTab(tab);
      });

      tab.addEventListener('dragstart', (e) => {
        draggedTab = tab;
        tabDragStartX = e.clientX;
        tabDragStartY = e.clientY;
        setTimeout(() => {
          tab.classList.add('dragging');
        }, 0);
      });

      tab.addEventListener('dragend', () => {
        tab.classList.remove('dragging');
        draggedTab = null;
      });

      return tab;
    }

    function activateTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      document.querySelectorAll('.tab-dropzone').forEach(content => {
        content.style.display = 'none';
      });

      const tabId = tab.dataset.tabId;
      const tabContent = document.getElementById(tabId + '-content');
      if (tabContent) {
        tabContent.style.display = 'block';
      }

      document.getElementById('dropzone-text').style.display = 'none';
    }

    const dropzone = document.getElementById('dropzone');

    dropzone.addEventListener('dragover', function (e) {
      e.preventDefault();
      const activeTabContent = document.querySelector('.tab-dropzone[style*="display: block"]');
      if (!activeTabContent || !activeTabContent.contains(e.target)) {
        dropzone.classList.add('active');
      }
    });

    dropzone.addEventListener('dragleave', function () {
      dropzone.classList.remove('active');
    });

    dropzone.addEventListener('drop', function (e) {
      e.preventDefault();
      dropzone.classList.remove('active');

      const type = e.dataTransfer.getData('type');
      console.log('Dropped type:', type);

      if (!document.getElementById('tabs-container')) {
        if (type === 'tab') {
          console.log('Tab dropped successfully');
          let tabsContainer = document.createElement('div');
          tabsContainer.id = 'tabs-container';
          tabsContainer.className = 'tabs-container';
          dropzone.insertBefore(tabsContainer, dropzone.firstChild);

          const newTab = createTab();
          tabsContainer.appendChild(newTab);
          activateTab(newTab);

          document.getElementById('dropzone-text').style.display = 'none';

          let addTabDropzone = document.createElement('div');
          addTabDropzone.id = 'add-tab-dropzone';
          addTabDropzone.className = 'add-tab-dropzone';
          addTabDropzone.textContent = 'Drop a Tab';
          dropzone.appendChild(addTabDropzone);

          // Attach the dragover event listener to tabsContainer after it's created
          tabsContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!draggedTab) return;

            const afterElement = getDragAfterElement(tabsContainer, e.clientX);

            if (afterElement) {
              tabsContainer.insertBefore(draggedTab, afterElement);
            } else {
              tabsContainer.appendChild(draggedTab);
            }
          });

          addTabDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            addTabDropzone.classList.add('active');
          });

          addTabDropzone.addEventListener('dragleave', () => {
            addTabDropzone.classList.remove('active');
          });

          addTabDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            addTabDropzone.classList.remove('active');
            const dropType = e.dataTransfer.getData('type');
            console.log('Dropped into Add Tab Dropzone, type:', dropType);
            if (dropType === 'tab') {
              const tabsContainer = document.getElementById('tabs-container');
              const newTab = createTab();
              tabsContainer.appendChild(newTab);
              activateTab(newTab);
            } else {
              alert('Please drop a Tab here.');
            }
          });
        } else {
          console.log('Invalid drop: Expected a Tab, got:', type);
          alert('Only a Tab can be dropped here initially.');
        }
      }
    });

    function handleDrop(e, target) {
      e.preventDefault();
      e.stopPropagation(); // Prevent event from bubbling up to parent dropzones

      const type = e.dataTransfer.getData('type');

      // Ensure the drop target is a grid-col
      const dropTarget = e.target.closest('.grid-col');
      if (!dropTarget) {
        alert('You can only drop fields or fieldsets inside a valid grid column.');
        return;
      }

      if (type === 'field') {
        // Re-enable the previous field button if the column already contains禁止使用 (Please use) contains a field
        const existingFieldId = dropTarget.dataset.fieldId;
        if (existingFieldId) {
          const existingFieldButton = document.getElementById(existingFieldId);
          if (existingFieldButton) {
            existingFieldButton.classList.remove('disabled');
            console.log(`Re-enabled field button: ${existingFieldId}`);
          }
        }

        // Clear the previous fieldId from the column
        delete dropTarget.dataset.fieldId;

        // Check if the column already contains a field (input) or fieldset
        if (dropTarget.querySelector('input') || dropTarget.querySelector('.fieldset-container')) {
          alert('This column already contains a field or fieldset. Each column can only have one field or fieldset.');
          return;
        }
        const fieldType = e.dataTransfer.getData('fieldType');
        const fieldLabel = e.dataTransfer.getData('label');
        const fieldId = e.dataTransfer.getData('fieldId');
        replaceFieldInGrid(dropTarget, fieldType, fieldLabel);

        // Disable the dragged field button
        const fieldButton = document.getElementById(fieldId);
        if (fieldButton) {
          fieldButton.classList.add('disabled');
        }
      } else if (type === 'fieldset') {
        // Check if the column already contains a field (input) or fieldset
        if (dropTarget.querySelector('input') || dropTarget.querySelector('.fieldset-container')) {
          alert('This column already contains a field or fieldset. Each column can only have one field or fieldset.');
          return;
        }

        // Transform the grid-col into a container
        transformGridColToContainer(dropTarget);

        // Reattach drag-and-drop listeners to preserve grid functionality
        dropTarget.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('colId', dropTarget.id);
          dropTarget.classList.add('dragging');
        });

        dropTarget.addEventListener('dragend', () => {
          dropTarget.classList.remove('dragging');
          normalizeRowFlex(dropTarget.parentNode);
        });

        dropTarget.addEventListener('dragover', (e) => {
          e.preventDefault();
          const draggedCol = document.querySelector('.grid-col.dragging');
          if (draggedCol && draggedCol !== dropTarget) {
            if (draggedCol.parentNode === dropTarget.parentNode) {
              const rect = dropTarget.getBoundingClientRect();
              const x = e.clientX - rect.left;
              if (x < rect.width / 2) {
                dropTarget.parentNode.insertBefore(draggedCol, dropTarget);
              } else {
                dropTarget.parentNode.insertBefore(draggedCol, dropTarget.nextSibling);
              }
            }
          }
        });
      } else {
        alert('Only fields or fieldsets can be dropped into a column.');
        return;
      }

      // Normalize flex values after a successful drop
      normalizeRowFlex(dropTarget.parentNode);
    }

    function createColumn(className = '', flexValue = 1) {
      const col = document.createElement('div');
      col.className = `grid-col ${className}`;
      col.style.border = '2px dashed gray';
      col.style.minHeight = '40px';
      col.style.flex = flexValue.toString();
      col.dataset.flex = flexValue.toString();
      col.id = `col-${Date.now()}`;
      col.draggable = true;

      // Add placeholder text
      const placeholder = document.createElement('div');
      placeholder.className = 'column-placeholder';
      placeholder.textContent = 'Control or Fieldset';
      placeholder.style.textAlign = 'center';
      placeholder.style.color = '#999';
      placeholder.style.fontSize = '14px';
      placeholder.style.pointerEvents = 'none';
      placeholder.style.marginTop = '-9px';
      col.appendChild(placeholder);

      const iconsContainer = document.createElement('div');
      iconsContainer.className = 'column-icons';
      iconsContainer.innerHTML = `
    <div class="left-icons">
      <i class="fas fa-arrows-alt drag-handle" style="font-size: 20px; color: #00aaff; cursor: move;"></i>
      <i class="fas fa-cog" style="font-size: 20px; color: #00aaff;"></i>
    </div>
    <div class="center-icons">
      <i class="fas fa-less-than" style="font-size: 20px; color: #00aaff;cursor: pointer;"></i>
      <i class="fas fa-greater-than" style="font-size: 20px; color: #00aaff;cursor: pointer"></i>
    </div>
    <div class="right-icons">
      <i class="fas fa-trash delete-column" style="font-size: 20px; color: red; cursor: pointer;"></i>
    </div>
  `;
      col.appendChild(iconsContainer);

      col.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('colId', col.id);
        col.classList.add('dragging');
      });

      col.addEventListener('dragend', () => {
        col.classList.remove('dragging');
        normalizeRowFlex(col.parentNode);
      });

      col.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggedCol = document.querySelector('.grid-col.dragging');
        if (draggedCol && draggedCol !== col) {
          if (draggedCol.parentNode === col.parentNode) {
            const rect = col.getBoundingClientRect();
            const x = e.clientX - rect.left;
            if (x < rect.width / 2) {
              col.parentNode.insertBefore(draggedCol, col);
            } else {
              col.parentNode.insertBefore(draggedCol, col.nextSibling);
            }
          }
        }
      });

      col.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation(); // Prevent event from bubbling up to parent dropzones
        const type = e.dataTransfer.getData('type');
        // Only allow fields and fieldsets to be dropped
        if (type === 'field' || type === 'fieldset') {
          handleDrop(e, col);
        } else {
          alert('Only fields or fieldsets can be dropped into a column.');
        }
      });

      return col;
    }

    // Helper function to transform a grid-col into a container
    function transformGridColToContainer(gridCol) {
      // Clear the existing content of the grid-col
      gridCol.innerHTML = '';

      // Apply styles to match the container in the image
      gridCol.classList.remove('grid-col'); // Remove grid-col class to avoid conflicting styles
      gridCol.classList.add('fieldset-container'); // Add fieldset-container class
      gridCol.style.border = '2px solid rgba(7, 197, 255, 0.8)';
      gridCol.style.borderRadius = '4px';
      gridCol.style.width = '100%';
      gridCol.style.boxSizing = 'border-box';
      gridCol.style.marginTop = '0px';
      gridCol.style.position = 'relative';
      gridCol.style.minHeight = 'auto';
      gridCol.style.overflowX = 'auto';
      gridCol.style.scrollbarWidth = 'thin';
      gridCol.style.flex = gridCol.dataset.flex;
      gridCol.style.flexDirection = 'column';
      gridCol.draggable = true; // Make the entire fieldset-container draggable

      // Create a wrapper for the name and icons
      const nameWrapper = document.createElement('div');
      nameWrapper.className = 'fieldset-name-wrapper';
      nameWrapper.style.position = 'absolute';
      nameWrapper.style.top = '0px';
      nameWrapper.style.left = '35px';
      nameWrapper.style.display = 'flex';
      nameWrapper.style.alignItems = 'center';
      nameWrapper.style.gap = '5px';

      // Create left icons container (for Move icon)
      const leftIcons = document.createElement('div');
      leftIcons.className = 'fieldset-icons left-icons';
      leftIcons.style.display = 'none'; // Hidden by default

      // Create Move icon
      const moveIcon = document.createElement('i');
      moveIcon.className = 'fas fa-arrows-alt move-fieldset';
      moveIcon.style.fontSize = '14px';
      moveIcon.style.color = '#00aaff';
      moveIcon.style.cursor = 'move';
      leftIcons.appendChild(moveIcon);

      // Create an editable name for the fieldset-container
      const fieldsetName = document.createElement('span');
      fieldsetName.className = 'fieldset-name';
      fieldsetName.contentEditable = true;
      fieldsetName.textContent = 'Fieldset'; // Default name
      fieldsetName.style.backgroundColor = '#f4f7fc';
      fieldsetName.style.padding = '2px 5px';
      fieldsetName.style.fontSize = '14px';
      fieldsetName.style.color = '#333';
      fieldsetName.style.cursor = 'text';

      // Add focus and blur styling for better UX
      fieldsetName.addEventListener('focus', () => {
        fieldsetName.style.backgroundColor = '#fff';
        fieldsetName.style.border = '1px solid rgba(7, 197, 255, 0.8)';
        fieldsetName.style.borderRadius = '4px';
      });

      fieldsetName.addEventListener('blur', () => {
        fieldsetName.style.backgroundColor = '#f4f7fc';
        fieldsetName.style.border = 'none';
      });

      // Create right icons container (for Delete icon)
      const rightIcons = document.createElement('div');
      rightIcons.className = 'fieldset-icons right-icons';
      rightIcons.style.display = 'none'; // Hidden by default

      // Create Delete icon
      const deleteIcon = document.createElement('i');
      deleteIcon.className = 'fas fa-trash delete-fieldset';
      deleteIcon.style.fontSize = '14px';
      deleteIcon.style.color = 'red';
      deleteIcon.style.cursor = 'pointer';
      rightIcons.appendChild(deleteIcon);

      // Append icons and name to the wrapper
      nameWrapper.appendChild(leftIcons);
      nameWrapper.appendChild(fieldsetName);
      nameWrapper.appendChild(rightIcons);

      // Show icons on hover over the name wrapper
      nameWrapper.addEventListener('mouseenter', () => {
        leftIcons.style.display = 'flex';
        rightIcons.style.display = 'flex';
      });

      nameWrapper.addEventListener('mouseleave', () => {
        if (document.activeElement !== fieldsetName) {
          leftIcons.style.display = 'none';
          rightIcons.style.display = 'none';
        }
      });

      // Ensure icons remain visible if the name is focused
      fieldsetName.addEventListener('focus', () => {
        leftIcons.style.display = 'flex';
        rightIcons.style.display = 'flex';
      });

      fieldsetName.addEventListener('blur', () => {
        if (!nameWrapper.matches(':hover')) {
          leftIcons.style.display = 'none';
          rightIcons.style.display = 'none';
        }
      });

      // Handle delete functionality
      deleteIcon.addEventListener('click', () => {
        const parentRow = gridCol.parentNode;
        const layout = parentRow.dataset.layout;
        const colFlex = parseFloat(gridCol.dataset.flex || gridCol.style.flex || '0');

        // Remove the fieldset-container
        gridCol.remove();

        // Create or update the Add Column button
        let addButton = parentRow.querySelector('.add-column-button');
        if (addButton) {
          const currentAddButtonFlex = parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
          const newAddButtonFlex = currentAddButtonFlex + colFlex;
          addButton.style.flex = newAddButtonFlex.toString();
          addButton.dataset.flex = newAddButtonFlex.toString();
        } else {
          addButton = createAddColumnButton(colFlex, layout);
          parentRow.appendChild(addButton);
        }

        // If no columns remain, create a new row with the Add Column button
        if (!parentRow.querySelector('.fieldset-container') && !parentRow.querySelector('.grid-col')) {
          const container = parentRow.parentNode;
          const newRow = document.createElement('div');
          newRow.className = 'grid-row';
          newRow.style.height = '40px';
          newRow.dataset.layout = layout;
          newRow.appendChild(addButton);
          container.appendChild(newRow);
          parentRow.remove();
        }
      });

      // Handle drag-and-drop for moving the fieldset-container
      gridCol.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('move-fieldset')) {
          e.dataTransfer.setData('colId', gridCol.id);
          gridCol.classList.add('dragging');
        } else {
          e.preventDefault();
        }
      });

      gridCol.addEventListener('dragend', () => {
        gridCol.classList.remove('dragging');
        normalizeRowFlex(gridCol.parentNode);
      });

      gridCol.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggedCol = document.querySelector('.fieldset-container.dragging');
        if (draggedCol && draggedCol !== gridCol) {
          if (draggedCol.parentNode === gridCol.parentNode) {
            const rect = gridCol.getBoundingClientRect();
            const x = e.clientX - rect.left;
            if (x < rect.width / 2) {
              gridCol.parentNode.insertBefore(draggedCol, gridCol);
            } else {
              gridCol.parentNode.insertBefore(draggedCol, gridCol.nextSibling);
            }
          }
        }
      });

      // Create a "Drop a Row" placeholder
      const rowPlaceholder = document.createElement('div');
      rowPlaceholder.className = 'row-placeholder';
      rowPlaceholder.textContent = 'Drop a Row';
      rowPlaceholder.style.border = '3px dashed rgba(7, 197, 255, 0.8)';
      rowPlaceholder.style.backgroundColor = '#f4f7fc';
      rowPlaceholder.style.padding = '10px';
      rowPlaceholder.style.textAlign = 'center';
      rowPlaceholder.style.color = '#666';
      rowPlaceholder.style.marginBottom = '10px';

      // Add drag-and-drop listeners to the placeholder
      rowPlaceholder.addEventListener('dragover', (e) => {
        e.preventDefault();
        rowPlaceholder.classList.add('active');
      });

      rowPlaceholder.addEventListener('dragleave', () => {
        rowPlaceholder.classList.remove('active');
      });

      rowPlaceholder.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        rowPlaceholder.classList.remove('active');

        const type = e.dataTransfer.getData('type');
        const layout = e.dataTransfer.getData('layout');

        if (type === 'layout' && layout) {
          createGridLayout(layout, gridCol);
          gridCol.appendChild(rowPlaceholder);
        } else {
          alert('Please drop a valid row layout.');
        }
      });

      // Append the name wrapper and placeholder to the container
      gridCol.appendChild(nameWrapper);
      gridCol.appendChild(rowPlaceholder);

      // Normalize the parent row's flex values
      normalizeRowFlex(gridCol.parentNode);
    }

    function addFieldToGrid(target, fieldType, fieldLabel) {
      const formField = document.createElement('div');
      formField.classList.add('form-field');

      const label = document.createElement('label');
      label.style.fontSize = '14px';
      label.style.color = '#333';
      label.style.marginBottom = '5px';
      label.style.display = 'block';

      const labelText = document.createElement('span');
      labelText.textContent = fieldLabel;
      const requiredAsterisk = document.createElement('span');
      requiredAsterisk.textContent = ' *';
      requiredAsterisk.style.color = 'red';
      label.appendChild(labelText);
      label.appendChild(requiredAsterisk);

      const input = document.createElement('input');
      input.type = fieldType === 'email' ? 'email' : 'text';
      input.placeholder = `Enter ${fieldLabel}`;
      input.style.width = '100%';
      input.style.padding = '10px';
      input.style.border = '1px solid #ccc';
      input.style.borderRadius = '4px';
      input.style.fontSize = '14px';
      input.style.boxSizing = 'border-box';
      input.style.backgroundColor = '#f5f5f5';

      input.addEventListener('focus', () => {
        input.style.borderColor = 'rgba(7, 197, 255, 0.8)';
        input.style.outline = 'none';
      });

      input.addEventListener('blur', () => {
        input.style.borderColor = '#ccc';
      });

      formField.appendChild(label);
      formField.appendChild(input);

      target.appendChild(formField);
    }

    function normalizeRowFlex(row) {
      const columns = row.querySelectorAll('.grid-col,.fieldset-container');
      const addButton = row.querySelector('.add-column-button');

      let totalFlex = 0;
      columns.forEach(col => {
        const flex = parseFloat(col.dataset.flex || col.style.flex || '0');
        totalFlex += flex;
      });
      if (addButton) {
        const flex = parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
        totalFlex += flex;
      }

      console.log('Total flex before normalization:', totalFlex);

      if (totalFlex === 0) return;

      const scaleFactor = 12 / totalFlex;
      columns.forEach(col => {
        const currentFlex = parseFloat(col.dataset.flex || col.style.flex || '0');
        const newFlex = currentFlex * scaleFactor;
        col.style.flex = newFlex.toFixed(2);
        col.dataset.flex = newFlex.toFixed(2);
      });
      if (addButton) {
        const currentFlex = parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
        const newFlex = currentFlex * scaleFactor;
        addButton.style.flex = newFlex.toFixed(2);
        addButton.dataset.flex = newFlex.toFixed(2);
      }

      let totalAfter = 0;
      columns.forEach(col => {
        totalAfter += parseFloat(col.dataset.flex || col.style.flex || '0');
      });
      if (addButton) {
        totalAfter += parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
      }
      console.log('Total flex after normalization:', totalAfter);
    }

    function createGridLayout(layout, target) {
      const container = document.createElement('div');
      container.className = 'grid-container';
      const row = document.createElement('div');
      row.className = 'grid-row';
      row.dataset.layout = layout;

      switch (layout) {
        case '1-row':
          row.appendChild(createColumn('col-1', 12));
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
        case '2-equal':
          row.appendChild(createColumn('', 6));
          row.appendChild(createColumn('', 6));
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
        case '3-equal':
          row.appendChild(createColumn('', 4));
          row.appendChild(createColumn('', 4));
          row.appendChild(createColumn('', 4));
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
        case '4-equal':
          row.appendChild(createColumn('', 3));
          row.appendChild(createColumn('', 3));
          row.appendChild(createColumn('', 3));
          row.appendChild(createColumn('', 3));
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
        case '1-2-split':
          row.appendChild(createColumn('', 4));
          row.appendChild(createColumn('col-2', 8));
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
        case '2-1-split':
          row.appendChild(createColumn('col-2', 8));
          row.appendChild(createColumn('', 4));
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
        case '5-equal':
          for (let i = 0; i < 5; i++) {
            row.appendChild(createColumn('', 2.4));
          }
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
        case '2-8-2-split':
          row.appendChild(createColumn('', 2));
          row.appendChild(createColumn('', 8));
          row.appendChild(createColumn('', 2));
          row.style.minHeight = '40px';
          row.style.maxHeight = 'auto';
          break;
      }
      container.appendChild(row);
      target.appendChild(container); // Ensure the grid is appended to the correct target
    }

    // make grid to input 
    function replaceFieldInGrid(target, fieldType, fieldLabel) {
      // Clear the existing content but keep the grid-col class
      target.innerHTML = ''; // Remove previous content (including icons)
      target.style.border = '1px solid gray'; // Gray border to match the image
      target.style.borderRadius = '4px'; // Rounded corners
      target.style.backgroundColor = '#f4f7fc';
      target.style.padding = '15px'; // Increased padding to accommodate the label
      target.style.minHeight = 'auto'; // Allow the height to adjust to the input
      target.style.display = 'flex';
      target.style.flexDirection = 'column'; // Stack label and input vertically
      target.style.alignItems = 'stretch'; // Stretch to full width

      // Store the fieldId in the grid column's dataset
      target.dataset.fieldId = `field-${fieldType}`; // Store the fieldId (e.g., 'field-firstname')

      // Recreate the column icons to ensure they persist
      const iconsContainer = document.createElement('div');
      iconsContainer.className = 'column-icons';
      iconsContainer.style.zIndex = '30'; // Higher z-index than the input
      iconsContainer.innerHTML = `
        <div class="left-icons">
            <i class="fas fa-arrows-alt drag-handle" style="font-size: 20px; color: #00aaff; cursor: move;"></i>
            <i class="fas fa-cog setting-input" style="font-size: 20px; color: #00aaff;cursor: pointer"></i>
        </div>
        <div class="center-icons">
            <i class="fas fa-less-than" style="font-size: 20px; color: #00aaff; cursor: pointer;"></i>
            <i class="fas fa-greater-than" style="font-size: 20px; color: #00aaff; cursor: pointer"></i>
        </div>
        <div class="right-icons">
            <i class="fas fa-trash delete-column" style="font-size: 20px; color: red; cursor: pointer;"></i>
        </div>
    `;
      target.appendChild(iconsContainer);

      // Create the input field
      const input = document.createElement('input');
      input.type = fieldType === 'email' ? 'email' : 'text';
      input.placeholder = ' '; // Space ensures the placeholder-shown logic works
      input.style.width = '100%';
      input.style.padding = '10px 0 5px 0'; // Adjusted padding
      input.style.border = 'none'; // No border on the input itself since the parent has the border
      input.style.borderRadius = '4px';
      input.style.fontSize = '14px';
      input.style.boxSizing = 'border-box';
      input.style.backgroundColor = '#f5f5f5'; // Transparent background to use the parent's background
      input.style.zIndex = '20'; // Lower z-index than the icons by default

      // Create the label element
      const label = document.createElement('label');
      label.className = 'grid-col-label';
      label.textContent = fieldLabel; // Use the field label (e.g., "Last Name")

      // Add focus and blur effects for the border
      input.addEventListener('focus', () => {
        target.style.borderColor = 'rgba(7, 197, 255, 0.8)';
        input.style.outline = 'none';
        // Hide the column icons when the input is focused
        iconsContainer.style.display = 'none';
      });

      input.addEventListener('blur', () => {
        target.style.borderColor = '#ccc';
        // Show the column icons on blur, but only if the grid-col is hovered
        if (target.matches(':hover')) {
          iconsContainer.style.display = 'flex';
        }
      });

      // Append the input and label to the target
      target.appendChild(input);
      target.appendChild(label); // Label must be after the input for the sibling selector to work

      // Ensure the target retains drag-and-drop functionality
      target.draggable = true;

      // Reattach event listeners to preserve grid functionality
      target.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('colId', target.id);
        target.classList.add('dragging');
      });

      target.addEventListener('dragend', () => {
        target.classList.remove('dragging');
        normalizeRowFlex(target.parentNode);
      });

      target.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggedCol = document.querySelector('.grid-col.dragging');
        if (draggedCol && draggedCol !== target) {
          if (draggedCol.parentNode === target.parentNode) {
            const rect = target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            if (x < rect.width / 2) {
              target.parentNode.insertBefore(draggedCol, target);
            } else {
              target.parentNode.insertBefore(draggedCol, target.nextSibling);
            }
          }
        }
      });

      target.addEventListener('drop', (e) => {
        e.preventDefault();
        handleDrop(e, target);
        normalizeRowFlex(target.parentNode);
      });

      // Add mouseenter and mouseleave events to show/hide icons based on focus state
      target.addEventListener('mouseenter', () => {
        // Only show icons if the input is not focused
        if (document.activeElement !== input) {
          iconsContainer.style.display = 'flex';
        }
      });

      target.addEventListener('mouseleave', () => {
        // Hide icons when not hovering, regardless of focus state
        iconsContainer.style.display = 'none';
      });

      // Normalize the parent row's flex values
      normalizeRowFlex(target.parentNode);
    }

    function openFieldSettings(fieldType, fieldLabel, input) {
      console.log('openFieldSettings called with:', { fieldType, fieldLabel, input });
      const modal = document.createElement('div');
      modal.className = 'settings-modal';
      modal.style.position = 'fixed';
      modal.style.top = '50%';
      modal.style.left = '50%';
      modal.style.transform = 'translate(-50%, -50%)';
      modal.style.background = '#fff';
      modal.style.padding = '20px';
      modal.style.borderRadius = '8px';
      modal.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
      modal.style.zIndex = '1000';

      modal.innerHTML = `
    <h4 style="display:flex;justify-content:center;margin-top:-5px">${fieldLabel}</h4>
    <label style="display: block; margin-bottom: 12px;">
      <span style="font-weight:600">Input</span><br>
      <select id="field-type-input" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;margin-top:4px;">
        <option value="text" ${fieldType === 'text' ? 'selected' : ''}>Short Text</option>
        <option value="email" ${fieldType === 'email' ? 'selected' : ''}>Email</option>
      </select>
    </label>
    <label style="display: block; margin-bottom: 12px;">
      <span style="font-weight:600">Label Name</span><br>
      <input type="text" id="label-input" value="${fieldLabel}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;margin-top:4px;" />
    </label>
    <label style="display: block; margin-bottom: 12px;">
      <span style="font-weight:600">Tooltip</span><br>
      <input type="text" id="tooltip-input" value="${input.title || ''}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;margin-top:4px;" />
    </label>
    <label style="display: block; margin-bottom: 12px;">
      <span style="font-weight:600">Placeholder Description</span><br>
      <input type="text" id="placeholder-input" value="${input.placeholder === ' ' ? '' : input.placeholder}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;margin-top:4px;" />
    </label>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <label style="flex: 1;">
        <span style="font-weight:600">Maximum Length</span><br>
        <input type="number" id="charlength-input" value="${input.maxLength > 0 ? input.maxLength : ''}" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px;margin-top:4px;" />
      </label>
      <label style="flex: 1; text-align: right;">
        <span style="font-weight:600">Read Only</span><br>
        <input type="checkbox" id="readonly-input" ${input.readOnly ? 'checked' : ''} /> Yes
      </label>
    </div>
    <div style="display: flex; justify-content: space-between;">
      <button id="save-settings" style="background: #28a745; color: #fff; border: none; padding: 7px; border-radius: 4px; cursor: pointer;">Done</button>
      <button id="close-settings" style="background: #6c757d; color: #fff; border: none; padding: 7px; border-radius: 4px; cursor: pointer;">Cancel</button>
    </div>
  `;

      document.body.appendChild(modal);

      document.getElementById('save-settings').onclick = () => {
        const newFieldType = document.getElementById('field-type-input').value;
        const labelName = document.getElementById('label-input').value;
        const placeholder = document.getElementById('placeholder-input').value;
        const tooltip = document.getElementById('tooltip-input').value;
        const readOnly = document.getElementById('readonly-input').checked;
        const charLength = document.getElementById('charlength-input').value;

        input.type = newFieldType;
        input.placeholder = placeholder || ' '; // Ensure placeholder isn't empty for CSS selector
        input.title = tooltip;
        input.readOnly = readOnly;
        input.maxLength = charLength ? parseInt(charLength, 10) : 0;

        const labelElement = input.nextElementSibling;
        if (labelElement && labelElement.tagName === 'LABEL') {
          labelElement.textContent = labelName;
        } else {
          console.error('Label element not found for updating:', labelElement);
        }

        console.log('Settings saved:', { newFieldType, labelName, placeholder, tooltip, readOnly, charLength });
        modal.remove();
      };

      document.getElementById('close-settings').onclick = () => {
        console.log('Settings dialog closed without saving');
        modal.remove();
      };
    }

    // shrink and stretching colum 
    document.addEventListener('click', (e) => {
      const lessThanIcon = e.target.closest('.fa-less-than');
      const greaterThanIcon = e.target.closest('.fa-greater-than');
      const gearIcon = e.target.closest('.setting-input');
      if (lessThanIcon) {
        console.log('Less than icon clicked');

        const col = lessThanIcon.closest('.grid-col');
        if (col) {
          const parentRow = col.parentNode;
          const layout = parentRow.dataset.layout || 'custom';

          const currentFlex = parseFloat(col.dataset.flex || col.style.flex || '0');
          if (currentFlex <= 1) {
            alert('Cannot reduce the column width further.');
            return;
          }

          const columns = parentRow.querySelectorAll('.grid-col');
          let addButton = parentRow.querySelector('.add-column-button');
          let totalGridUnits = 0;
          columns.forEach(c => {
            totalGridUnits += parseFloat(c.dataset.flex || c.style.flex || '0');
          });
          if (addButton) {
            totalGridUnits += parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
          }
          console.log('Total grid units before decrease:', totalGridUnits);

          const newFlex = currentFlex - 1;
          col.style.flex = newFlex.toString();
          col.dataset.flex = newFlex.toString();

          const reducedFlex = 1;
          if (addButton) {
            const currentAddButtonFlex = parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
            const newAddButtonFlex = currentAddButtonFlex + reducedFlex;
            addButton.style.flex = newAddButtonFlex.toString();
            addButton.dataset.flex = newAddButtonFlex.toString();
          } else {
            addButton = createAddColumnButton(reducedFlex, layout);
            parentRow.appendChild(addButton);
          }

          totalGridUnits = 0;
          columns.forEach(c => {
            totalGridUnits += parseFloat(c.dataset.flex || c.style.flex || '0');
          });
          if (addButton) {
            totalGridUnits += parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
          }
          console.log('Total grid units after decrease:', totalGridUnits);
        } else {
          console.error('Column not found');
        }
      }

      if (greaterThanIcon) {
        console.log('Greater than icon clicked');

        const col = greaterThanIcon.closest('.grid-col');
        if (col) {
          const parentRow = col.parentNode;
          const layout = parentRow.dataset.layout || 'custom';

          let addButton = parentRow.querySelector('.add-column-button');

          if (!addButton) {
            alert('Stretch not possible - row is full. Shrink a control first to make room.');
            return;
          }

          const columns = parentRow.querySelectorAll('.grid-col');
          let totalGridUnits = 0;
          columns.forEach(c => {
            totalGridUnits += parseFloat(c.dataset.flex || c.style.flex || '0');
          });
          const addButtonFlex = parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
          totalGridUnits += addButtonFlex;
          console.log('Total grid units before increase:', totalGridUnits);

          const currentFlex = parseFloat(col.dataset.flex || col.style.flex || '0');
          const newFlex = currentFlex + 1;
          col.style.flex = newFlex.toString();
          col.dataset.flex = newFlex.toString();

          const newAddButtonFlex = addButtonFlex - 1;
          if (newAddButtonFlex <= 0) {
            addButton.remove();
          } else {
            addButton.style.flex = newAddButtonFlex.toString();
            addButton.dataset.flex = newAddButtonFlex.toString();
          }

          totalGridUnits = 0;
          columns.forEach(c => {
            totalGridUnits += parseFloat(c.dataset.flex || c.style.flex || '0');
          });
          addButton = parentRow.querySelector('.add-column-button');
          if (addButton) {
            totalGridUnits += parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
          }
          console.log('Total grid units after increase:', totalGridUnits);
        } else {
          console.error('Column not found');
        }
      }

      const deleteIcon = e.target.closest('.delete-column');
      if (deleteIcon) {
        console.log('Delete icon clicked');
        const col = deleteIcon.closest('.grid-col, .fieldset-container'); // Handle both grid-col and fieldset-container
        if (col) {
          const parentRow = col.parentNode;
          const layout = parentRow.dataset.layout;

          // Re-enable the field button if the column contains a field
          const fieldId = col.dataset.fieldId;
          if (fieldId) {
            const fieldButton = document.getElementById(fieldId);
            if (fieldButton) {
              fieldButton.classList.remove('disabled');
              console.log(`Re-enabled field button: ${fieldId}`);
            }
          }

          const colFlex = parseFloat(col.dataset.flex || col.style.flex || '0');
          col.remove();

          let addButton = parentRow.querySelector('.add-column-button');
          if (addButton) {
            const currentAddButtonFlex = parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
            const newAddButtonFlex = currentAddButtonFlex + colFlex;
            addButton.style.flex = newAddButtonFlex.toString();
            addButton.dataset.flex = newAddButtonFlex.toString();
          } else {
            addButton = createAddColumnButton(colFlex, layout);
            parentRow.appendChild(addButton);
          }

          // If no columns remain, create a new row with the Add Column button
          if (!parentRow.querySelector('.grid-col') && !parentRow.querySelector('.fieldset-container')) {
            const container = parentRow.parentNode;
            const newRow = document.createElement('div');
            newRow.className = 'grid-row';
            newRow.style.height = '40px';
            newRow.dataset.layout = layout;
            newRow.appendChild(addButton);
            container.appendChild(newRow);
            parentRow.remove();
          }

          let totalGridUnits = 0;
          const columns = parentRow.querySelectorAll('.grid-col, .fieldset-container');
          columns.forEach(c => {
            totalGridUnits += parseFloat(c.dataset.flex || c.style.flex || '0');
          });
          addButton = parentRow.querySelector('.add-column-button');
          if (addButton) {
            totalGridUnits += parseFloat(addButton.dataset.flex || addButton.style.flex || '0');
          }
          console.log('Total grid units after delete:', totalGridUnits);
        } else {
          console.error('Column or fieldset not found');
        }
      }

      if (gearIcon) {
        console.log('Gear icon clicked');
        const col = gearIcon.closest('.grid-col');
        if (col) {
          const input = col.querySelector('input');
          const label = col.querySelector('.grid-col-label');
          if (input && label) {
            const fieldType = input.type; // e.g., 'text' or 'email'
            const fieldLabel = label.textContent; // e.g., 'First Name'
            console.log('Opening settings with:', { fieldType, fieldLabel, input });
            openFieldSettings(fieldType, fieldLabel, input);
          } else {
            console.error('Input or label not found in the grid column:', { input, label });
          }
        } else {
          console.error('Grid column not found');
        }
      }
    });

    function createAddColumnButton(flexValue, layout) {
      const addButton = document.createElement('div');
      addButton.className = 'add-column-button';
      addButton.style.flex = flexValue.toString();
      addButton.dataset.flex = flexValue.toString();
      addButton.dataset.layout = layout;
      addButton.style.height = '40px';
      addButton.style.display = 'flex';
      addButton.style.alignItems = 'center';
      addButton.style.justifyContent = 'center';
      addButton.style.border = '2px dashed rgba(7, 197, 255, 0.8)';
      addButton.style.cursor = 'pointer';
      addButton.style.backgroundColor = '#fafdff';

      const icon = document.createElement('i');
      icon.className = 'fas fa-plus';
      icon.style.fontSize = '20px';
      icon.style.color = '#00aaff';

      addButton.appendChild(icon);

      addButton.addEventListener('click', () => {
        const currentFlex = parseFloat(addButton.dataset.flex);
        const layout = addButton.dataset.layout;
        const parentRow = addButton.parentNode;

        const newColumn = createColumn('', currentFlex);
        parentRow.insertBefore(newColumn, addButton);

        addButton.remove();

        let totalGridUnits = 0;
        const columns = parentRow.querySelectorAll('.grid-col');
        columns.forEach(c => {
          totalGridUnits += parseFloat(c.dataset.flex || c.style.flex || '0');
        });
        console.log('Total grid units after adding column:', totalGridUnits);

        if (layout === '1-2-split' || layout === '2-1-split') {
          const columns = parentRow.querySelectorAll('.grid-col');
          if (columns.length === 2) {
            if (layout === '1-2-split') {
              columns[0].style.flex = '4';
              columns[0].dataset.flex = '4';
              columns[1].style.flex = '8';
              columns[1].dataset.flex = '8';
            } else if (layout === '2-1-split') {
              columns[0].style.flex = '8';
              columns[0].dataset.flex = '8';
              columns[1].style.flex = '4';
              columns[1].dataset.flex = '4';
            }
          }
        }
      });

      return addButton;
    }


    // move colum function 
    function addDragAndDropFunctionality(col) {
      col.addEventListener('dragstart', (e) => {
        col.classList.add('dragging');
        e.dataTransfer.setData('text/plain', '');
      });

      col.addEventListener('dragend', () => {
        col.classList.remove('dragging');
      });

      col.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggedCol = document.querySelector('.grid-col.dragging');
        if (draggedCol && draggedCol !== col) {
          const rect = col.getBoundingClientRect();
          const x = e.clientX - rect.left;

          if (x < rect.width / 2) {
            col.parentNode.insertBefore(draggedCol, col);
          } else {
            col.parentNode.insertBefore(draggedCol, col.nextSibling);
          }
        }
      });
    }

    document.getElementById('tabs-container').addEventListener('dragover', (e) => {
      e.preventDefault();
      if (!draggedTab) return;

      const tabsContainer = document.getElementById('tabs-container');
      const afterElement = getDragAfterElement(tabsContainer, e.clientX);

      if (afterElement) {
        tabsContainer.insertBefore(draggedTab, afterElement);
      } else {
        tabsContainer.appendChild(draggedTab);
      }
    });

    function getDragAfterElement(container, x) {
      const draggableElements = [...container.querySelectorAll('.tab:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;

        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
  .grid-col {
    border: 2px dashed gray !important;
    min-height: 40px !important;
    padding: 8px !important;
  }
  .grid-col.active {
    border-color: rgba(7, 197, 255, 0.8);
    background: rgba(7, 197, 255, 0.05);
  }
  .grid-col.dragging {
   opacity: 0.5;
  border-style: dashed;
  border-color: #00aaff;
  }
  .grid-col.col-1 {
    flex: 1;
    height: 40px;
  }
  .grid-row {
    min-height: 40px !important;
  }
  .tab.dragging {
    opacity: 0.5;
    transform: scale(1.05);
    z-index: 100;
    background: #0088cc;
  }
  #tabs-container {
    position: relative;
  }
  .column-icons {
    background: rgba(255, 255, 255, 0.8);
    z-index: 10;
  }
`;
    document.head.appendChild(styleSheet);

    const faScript = document.createElement('script');
    faScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js';
    document.head.appendChild(faScript);
  </script>
</body>

</html>